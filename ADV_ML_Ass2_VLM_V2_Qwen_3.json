{
  "nbformat": 4,
  "nbformat_minor": 0,
  "metadata": {
    "colab": {
      "provenance": [],
      "gpuType": "T4",
      "authorship_tag": "ABX9TyN2/VO8AHYUU/Q0L1QNUzA7",
      "include_colab_link": true
    },
    "kernelspec": {
      "name": "python3",
      "display_name": "Python 3"
    },
    "language_info": {
      "name": "python"
    },
    "widgets": {
      "application/vnd.jupyter.widget-state+json": {
        "b6a1979f02924464999974093afc5d93": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_495b294bd479402c8949e62e5eb1f305",
              "IPY_MODEL_cb3abe0f2c7445b19142839e37c6f893",
              "IPY_MODEL_7d9a64facfa1485595b7c0a22ef920e5"
            ],
            "layout": "IPY_MODEL_9c389e08b3b84889aef9f6f9560df0cd"
          }
        },
        "495b294bd479402c8949e62e5eb1f305": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_d49d5a1fcd394ee381f3745585e9d5a9",
            "placeholder": "​",
            "style": "IPY_MODEL_eec07d8e951e4f46a1e9e8a0708b08fd",
            "value": "model.safetensors.index.json: "
          }
        },
        "cb3abe0f2c7445b19142839e37c6f893": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_8e85d7ab2815405498fa2d6f64c50bd1",
            "max": 1,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_16c07c189c9840c4870a889598484277",
            "value": 1
          }
        },
        "7d9a64facfa1485595b7c0a22ef920e5": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_63183eb3b8ab4d3893253eb8c2649fd6",
            "placeholder": "​",
            "style": "IPY_MODEL_0cb60d3e98854ede911f4ac14b1f07ff",
            "value": " 32.8k/? [00:00&lt;00:00, 928kB/s]"
          }
        },
        "9c389e08b3b84889aef9f6f9560df0cd": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "d49d5a1fcd394ee381f3745585e9d5a9": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "eec07d8e951e4f46a1e9e8a0708b08fd": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "8e85d7ab2815405498fa2d6f64c50bd1": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": "20px"
          }
        },
        "16c07c189c9840c4870a889598484277": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "63183eb3b8ab4d3893253eb8c2649fd6": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "0cb60d3e98854ede911f4ac14b1f07ff": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "3038b6a6961640b1ad92f19187b3f795": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_b4e62fca38f64d62af374f728fc3042d",
              "IPY_MODEL_36d00500059f4b8fb7936dd54a5c1652",
              "IPY_MODEL_490b5c5e23ff48e7b7581532d3db7648"
            ],
            "layout": "IPY_MODEL_ece70803808e41df94ce0764785cc270"
          }
        },
        "b4e62fca38f64d62af374f728fc3042d": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_84ae8fe0f6eb4aeca58ade1d88946dd4",
            "placeholder": "​",
            "style": "IPY_MODEL_7974869942d14bcbac910ac6544ca6b1",
            "value": "Fetching 3 files: 100%"
          }
        },
        "36d00500059f4b8fb7936dd54a5c1652": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_f7a30cb621174af6a1c53bacfaa2329d",
            "max": 3,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_3fa4c2f0eab14ce59095926bddaf1291",
            "value": 3
          }
        },
        "490b5c5e23ff48e7b7581532d3db7648": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_1ef06f9a4df6451bb295f176c96722f5",
            "placeholder": "​",
            "style": "IPY_MODEL_04436b720767431d8a08c8fc3d822b27",
            "value": " 3/3 [02:12&lt;00:00, 132.11s/it]"
          }
        },
        "ece70803808e41df94ce0764785cc270": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "84ae8fe0f6eb4aeca58ade1d88946dd4": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "7974869942d14bcbac910ac6544ca6b1": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "f7a30cb621174af6a1c53bacfaa2329d": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "3fa4c2f0eab14ce59095926bddaf1291": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "1ef06f9a4df6451bb295f176c96722f5": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "04436b720767431d8a08c8fc3d822b27": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "2cde100b345b48ddb235142138469af3": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_33b4ee75539d44c8823b7825f9019a8e",
              "IPY_MODEL_db03738e6d2c4ca59c22448d1b08e561",
              "IPY_MODEL_e3a183b7121e40aca60a09f86680292e"
            ],
            "layout": "IPY_MODEL_7e9b3d5fce254205ac59ff2b3175cd25"
          }
        },
        "33b4ee75539d44c8823b7825f9019a8e": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_5f220f311b824bd6a5378676ad2f6a11",
            "placeholder": "​",
            "style": "IPY_MODEL_060f1f7a43c6462f9949eb730612210d",
            "value": "model-00001-of-00003.safetensors: 100%"
          }
        },
        "db03738e6d2c4ca59c22448d1b08e561": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_ad405c214282471f83257543d33d6ebb",
            "max": 3957900840,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_eeb9e510925240adbc84c7a9785fae86",
            "value": 3957900840
          }
        },
        "e3a183b7121e40aca60a09f86680292e": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_1a93bfb99dbd43ea8724709596825caf",
            "placeholder": "​",
            "style": "IPY_MODEL_7b6aee84278c4d36b859fc477354b15c",
            "value": " 3.96G/3.96G [02:11&lt;00:00, 31.9MB/s]"
          }
        },
        "7e9b3d5fce254205ac59ff2b3175cd25": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "5f220f311b824bd6a5378676ad2f6a11": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "060f1f7a43c6462f9949eb730612210d": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "ad405c214282471f83257543d33d6ebb": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "eeb9e510925240adbc84c7a9785fae86": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "1a93bfb99dbd43ea8724709596825caf": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "7b6aee84278c4d36b859fc477354b15c": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "d62445c75dfc497b9b2bb3affa8eb6e3": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_4b58248fb9424897977874e759bd8c42",
              "IPY_MODEL_6469698f534b4bf3bc8cadfeca19e112",
              "IPY_MODEL_694aa736bae841dfbce734a034eed024"
            ],
            "layout": "IPY_MODEL_8a865ba245b84dedbe727ceef5d6dc56"
          }
        },
        "4b58248fb9424897977874e759bd8c42": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_6a533a548d17456380f353428e6fd996",
            "placeholder": "​",
            "style": "IPY_MODEL_00bba1d98f0c46c0b3079d4852ae3101",
            "value": "model-00003-of-00003.safetensors: 100%"
          }
        },
        "6469698f534b4bf3bc8cadfeca19e112": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_b7b7dfd037b844ecb29ed719fa1b232a",
            "max": 99630640,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_4c5f020542554e47bf617f76b3be61eb",
            "value": 99630640
          }
        },
        "694aa736bae841dfbce734a034eed024": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_dc6a5e092c97424cb9fd6b7127396dff",
            "placeholder": "​",
            "style": "IPY_MODEL_4c01bdd068f7491983072dde4c38c489",
            "value": " 99.6M/99.6M [00:13&lt;00:00, 7.02MB/s]"
          }
        },
        "8a865ba245b84dedbe727ceef5d6dc56": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "6a533a548d17456380f353428e6fd996": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "00bba1d98f0c46c0b3079d4852ae3101": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "b7b7dfd037b844ecb29ed719fa1b232a": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "4c5f020542554e47bf617f76b3be61eb": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "dc6a5e092c97424cb9fd6b7127396dff": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "4c01bdd068f7491983072dde4c38c489": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "40565222ac3e4ab58a72bb867c2007cc": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_48c891529f2b4d108328d817a3d3fe1e",
              "IPY_MODEL_530e051dbee64cdfb62fcf1e6074ad62",
              "IPY_MODEL_f8341f9fad1349478ce4817da04446c9"
            ],
            "layout": "IPY_MODEL_c3eea8b4a467425fba23268944c638aa"
          }
        },
        "48c891529f2b4d108328d817a3d3fe1e": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_55b92c3c29334bed91d1ccb72d3b7fa0",
            "placeholder": "​",
            "style": "IPY_MODEL_41ffd435136b4d09a99226313235f1b4",
            "value": "model-00002-of-00003.safetensors: 100%"
          }
        },
        "530e051dbee64cdfb62fcf1e6074ad62": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_b49c767d06df43d9a622d745b8ffb09c",
            "max": 3987450520,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_14015def70e84ef3a1ea2988e80e154e",
            "value": 3987450520
          }
        },
        "f8341f9fad1349478ce4817da04446c9": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_6efcdb5662014bc8a761d4ff45c33ef0",
            "placeholder": "​",
            "style": "IPY_MODEL_b77e7ded6c5941eb9aa85a94f83b2b52",
            "value": " 3.99G/3.99G [02:07&lt;00:00, 22.3MB/s]"
          }
        },
        "c3eea8b4a467425fba23268944c638aa": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "55b92c3c29334bed91d1ccb72d3b7fa0": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "41ffd435136b4d09a99226313235f1b4": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "b49c767d06df43d9a622d745b8ffb09c": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "14015def70e84ef3a1ea2988e80e154e": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "6efcdb5662014bc8a761d4ff45c33ef0": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "b77e7ded6c5941eb9aa85a94f83b2b52": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "95007928a678454aaaecd4e8e8f34d78": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_01154a2cc35a47a1aefb9dff9bc4a684",
              "IPY_MODEL_1ecc3a3aaa3f46539b974b21d0e0a5ab",
              "IPY_MODEL_13b7abfe119642d5af72367cc3ef1c7d"
            ],
            "layout": "IPY_MODEL_64beedaa6b274f1ca89e079f6ad0f62a"
          }
        },
        "01154a2cc35a47a1aefb9dff9bc4a684": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_f11c87229bc34bb883c762ad491c8e36",
            "placeholder": "​",
            "style": "IPY_MODEL_47566689616041a58274a067fcea3302",
            "value": "Loading checkpoint shards: 100%"
          }
        },
        "1ecc3a3aaa3f46539b974b21d0e0a5ab": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_fd1cfc7d3c2142649244eabe3d8769bb",
            "max": 3,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_5bf40a28316d4a0482979c8db09c5c76",
            "value": 3
          }
        },
        "13b7abfe119642d5af72367cc3ef1c7d": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_ace3710779e0489a9d54681b872aec2a",
            "placeholder": "​",
            "style": "IPY_MODEL_7858cca04e564250afc49cbfb7ed1dba",
            "value": " 3/3 [00:44&lt;00:00, 12.29s/it]"
          }
        },
        "64beedaa6b274f1ca89e079f6ad0f62a": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "f11c87229bc34bb883c762ad491c8e36": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "47566689616041a58274a067fcea3302": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "fd1cfc7d3c2142649244eabe3d8769bb": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "5bf40a28316d4a0482979c8db09c5c76": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "ace3710779e0489a9d54681b872aec2a": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "7858cca04e564250afc49cbfb7ed1dba": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "e9577dbffc5d403f8e05c030262b998c": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_0d57a053b9534d969291845d0f2c562f",
              "IPY_MODEL_3d43a496e89045458671fdad0fa63ad3",
              "IPY_MODEL_07ef1a45a4cb4a708bd925ca15869a62"
            ],
            "layout": "IPY_MODEL_239b9cebcdfd453cb2aa21a94cb65d9f"
          }
        },
        "0d57a053b9534d969291845d0f2c562f": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_7a8c9b82f9da456c95f20b56f19f80cf",
            "placeholder": "​",
            "style": "IPY_MODEL_9f8e56c88f7142a7bf2ba23c626fdaa6",
            "value": "generation_config.json: 100%"
          }
        },
        "3d43a496e89045458671fdad0fa63ad3": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_70c089238a1c4264a0f5b29b633e3086",
            "max": 238,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_2b7c810aba634443b978900e46c29493",
            "value": 238
          }
        },
        "07ef1a45a4cb4a708bd925ca15869a62": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_a960412a10bc434fa1c8f55d7e301e99",
            "placeholder": "​",
            "style": "IPY_MODEL_097e05cd6b794177bbb30fdcfb48a5c6",
            "value": " 238/238 [00:00&lt;00:00, 21.2kB/s]"
          }
        },
        "239b9cebcdfd453cb2aa21a94cb65d9f": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "7a8c9b82f9da456c95f20b56f19f80cf": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "9f8e56c88f7142a7bf2ba23c626fdaa6": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "70c089238a1c4264a0f5b29b633e3086": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "2b7c810aba634443b978900e46c29493": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "a960412a10bc434fa1c8f55d7e301e99": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "097e05cd6b794177bbb30fdcfb48a5c6": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        }
      }
    },
    "accelerator": "GPU"
  },
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {
        "id": "view-in-github",
        "colab_type": "text"
      },
      "source": [
        "<a href=\"https://colab.research.google.com/github/ChanZH0525/Adv-ML-QwenVLM/blob/main/ADV_ML_Ass2_VLM_V2_Qwen_3.ipynb\" target=\"_parent\"><img src=\"https://colab.research.google.com/assets/colab-badge.svg\" alt=\"Open In Colab\"/></a>"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {
        "id": "TAiQqb1WUWH2"
      },
      "outputs": [],
      "source": []
    },
    {
      "cell_type": "code",
      "metadata": {
        "id": "c09d1299"
      },
      "source": [
        "import requests\n",
        "from PIL import Image\n",
        "import torch\n",
        "from transformers import BlipProcessor, BlipForQuestionAnswering, BlipImageProcessor, AutoProcessor\n",
        "from transformers import BlipConfig\n",
        "from torch.utils.data import DataLoader\n",
        "from tqdm.notebook import tqdm\n",
        "import numpy as np\n",
        "import matplotlib.pyplot as plt\n",
        "from IPython.display import display\n",
        "import zipfile\n",
        "import pandas as pd\n",
        "from datasets import load_dataset"
      ],
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "!pip install bitsandbytes accelerate"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "PL2ti0W0wnQe",
        "outputId": "c4c5aec7-c3bb-48a1-d2de-b00a8e1beaa1"
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Requirement already satisfied: bitsandbytes in /usr/local/lib/python3.12/dist-packages (0.49.0)\n",
            "Requirement already satisfied: accelerate in /usr/local/lib/python3.12/dist-packages (1.12.0)\n",
            "Requirement already satisfied: torch<3,>=2.3 in /usr/local/lib/python3.12/dist-packages (from bitsandbytes) (2.9.0+cu126)\n",
            "Requirement already satisfied: numpy>=1.17 in /usr/local/lib/python3.12/dist-packages (from bitsandbytes) (2.0.2)\n",
            "Requirement already satisfied: packaging>=20.9 in /usr/local/lib/python3.12/dist-packages (from bitsandbytes) (25.0)\n",
            "Requirement already satisfied: psutil in /usr/local/lib/python3.12/dist-packages (from accelerate) (5.9.5)\n",
            "Requirement already satisfied: pyyaml in /usr/local/lib/python3.12/dist-packages (from accelerate) (6.0.3)\n",
            "Requirement already satisfied: huggingface_hub>=0.21.0 in /usr/local/lib/python3.12/dist-packages (from accelerate) (0.36.0)\n",
            "Requirement already satisfied: safetensors>=0.4.3 in /usr/local/lib/python3.12/dist-packages (from accelerate) (0.7.0)\n",
            "Requirement already satisfied: filelock in /usr/local/lib/python3.12/dist-packages (from huggingface_hub>=0.21.0->accelerate) (3.20.0)\n",
            "Requirement already satisfied: fsspec>=2023.5.0 in /usr/local/lib/python3.12/dist-packages (from huggingface_hub>=0.21.0->accelerate) (2025.3.0)\n",
            "Requirement already satisfied: requests in /usr/local/lib/python3.12/dist-packages (from huggingface_hub>=0.21.0->accelerate) (2.32.4)\n",
            "Requirement already satisfied: tqdm>=4.42.1 in /usr/local/lib/python3.12/dist-packages (from huggingface_hub>=0.21.0->accelerate) (4.67.1)\n",
            "Requirement already satisfied: typing-extensions>=3.7.4.3 in /usr/local/lib/python3.12/dist-packages (from huggingface_hub>=0.21.0->accelerate) (4.15.0)\n",
            "Requirement already satisfied: hf-xet<2.0.0,>=1.1.3 in /usr/local/lib/python3.12/dist-packages (from huggingface_hub>=0.21.0->accelerate) (1.2.0)\n",
            "Requirement already satisfied: setuptools in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (75.2.0)\n",
            "Requirement already satisfied: sympy>=1.13.3 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (1.14.0)\n",
            "Requirement already satisfied: networkx>=2.5.1 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.6.1)\n",
            "Requirement already satisfied: jinja2 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.1.6)\n",
            "Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.77)\n",
            "Requirement already satisfied: nvidia-cuda-runtime-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.77)\n",
            "Requirement already satisfied: nvidia-cuda-cupti-cu12==12.6.80 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.80)\n",
            "Requirement already satisfied: nvidia-cudnn-cu12==9.10.2.21 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (9.10.2.21)\n",
            "Requirement already satisfied: nvidia-cublas-cu12==12.6.4.1 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.4.1)\n",
            "Requirement already satisfied: nvidia-cufft-cu12==11.3.0.4 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (11.3.0.4)\n",
            "Requirement already satisfied: nvidia-curand-cu12==10.3.7.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (10.3.7.77)\n",
            "Requirement already satisfied: nvidia-cusolver-cu12==11.7.1.2 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (11.7.1.2)\n",
            "Requirement already satisfied: nvidia-cusparse-cu12==12.5.4.2 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.5.4.2)\n",
            "Requirement already satisfied: nvidia-cusparselt-cu12==0.7.1 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (0.7.1)\n",
            "Requirement already satisfied: nvidia-nccl-cu12==2.27.5 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (2.27.5)\n",
            "Requirement already satisfied: nvidia-nvshmem-cu12==3.3.20 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.3.20)\n",
            "Requirement already satisfied: nvidia-nvtx-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.77)\n",
            "Requirement already satisfied: nvidia-nvjitlink-cu12==12.6.85 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.85)\n",
            "Requirement already satisfied: nvidia-cufile-cu12==1.11.1.6 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (1.11.1.6)\n",
            "Requirement already satisfied: triton==3.5.0 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.5.0)\n",
            "Requirement already satisfied: mpmath<1.4,>=1.1.0 in /usr/local/lib/python3.12/dist-packages (from sympy>=1.13.3->torch<3,>=2.3->bitsandbytes) (1.3.0)\n",
            "Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.12/dist-packages (from jinja2->torch<3,>=2.3->bitsandbytes) (3.0.3)\n",
            "Requirement already satisfied: charset_normalizer<4,>=2 in /usr/local/lib/python3.12/dist-packages (from requests->huggingface_hub>=0.21.0->accelerate) (3.4.4)\n",
            "Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.12/dist-packages (from requests->huggingface_hub>=0.21.0->accelerate) (3.11)\n",
            "Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.12/dist-packages (from requests->huggingface_hub>=0.21.0->accelerate) (2.5.0)\n",
            "Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.12/dist-packages (from requests->huggingface_hub>=0.21.0->accelerate) (2025.11.12)\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "!pip install -U bitsandbytes"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "piDebM46w58H",
        "outputId": "087c806b-2631-4ba5-b240-4e47ab90aabb"
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Requirement already satisfied: bitsandbytes in /usr/local/lib/python3.12/dist-packages (0.49.0)\n",
            "Requirement already satisfied: torch<3,>=2.3 in /usr/local/lib/python3.12/dist-packages (from bitsandbytes) (2.9.0+cu126)\n",
            "Requirement already satisfied: numpy>=1.17 in /usr/local/lib/python3.12/dist-packages (from bitsandbytes) (2.0.2)\n",
            "Requirement already satisfied: packaging>=20.9 in /usr/local/lib/python3.12/dist-packages (from bitsandbytes) (25.0)\n",
            "Requirement already satisfied: filelock in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.20.0)\n",
            "Requirement already satisfied: typing-extensions>=4.10.0 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (4.15.0)\n",
            "Requirement already satisfied: setuptools in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (75.2.0)\n",
            "Requirement already satisfied: sympy>=1.13.3 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (1.14.0)\n",
            "Requirement already satisfied: networkx>=2.5.1 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.6.1)\n",
            "Requirement already satisfied: jinja2 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.1.6)\n",
            "Requirement already satisfied: fsspec>=0.8.5 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (2025.3.0)\n",
            "Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.77)\n",
            "Requirement already satisfied: nvidia-cuda-runtime-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.77)\n",
            "Requirement already satisfied: nvidia-cuda-cupti-cu12==12.6.80 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.80)\n",
            "Requirement already satisfied: nvidia-cudnn-cu12==9.10.2.21 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (9.10.2.21)\n",
            "Requirement already satisfied: nvidia-cublas-cu12==12.6.4.1 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.4.1)\n",
            "Requirement already satisfied: nvidia-cufft-cu12==11.3.0.4 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (11.3.0.4)\n",
            "Requirement already satisfied: nvidia-curand-cu12==10.3.7.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (10.3.7.77)\n",
            "Requirement already satisfied: nvidia-cusolver-cu12==11.7.1.2 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (11.7.1.2)\n",
            "Requirement already satisfied: nvidia-cusparse-cu12==12.5.4.2 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.5.4.2)\n",
            "Requirement already satisfied: nvidia-cusparselt-cu12==0.7.1 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (0.7.1)\n",
            "Requirement already satisfied: nvidia-nccl-cu12==2.27.5 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (2.27.5)\n",
            "Requirement already satisfied: nvidia-nvshmem-cu12==3.3.20 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.3.20)\n",
            "Requirement already satisfied: nvidia-nvtx-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.77)\n",
            "Requirement already satisfied: nvidia-nvjitlink-cu12==12.6.85 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (12.6.85)\n",
            "Requirement already satisfied: nvidia-cufile-cu12==1.11.1.6 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (1.11.1.6)\n",
            "Requirement already satisfied: triton==3.5.0 in /usr/local/lib/python3.12/dist-packages (from torch<3,>=2.3->bitsandbytes) (3.5.0)\n",
            "Requirement already satisfied: mpmath<1.4,>=1.1.0 in /usr/local/lib/python3.12/dist-packages (from sympy>=1.13.3->torch<3,>=2.3->bitsandbytes) (1.3.0)\n",
            "Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.12/dist-packages (from jinja2->torch<3,>=2.3->bitsandbytes) (3.0.3)\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "# Set device to GPU if available\n",
        "device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")"
      ],
      "metadata": {
        "id": "NrRYM8Z59YYA"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from google.colab import files\n",
        "# Upload zip file\n",
        "print(\"Upload your VQA-RAD images zip file:\")\n",
        "uploaded_zip = files.upload()\n",
        "\n",
        "# Upload CSV file\n",
        "print(\"\\nUpload your CSV file:\")\n",
        "uploaded_csv = files.upload()\n",
        "\n",
        "# Get filenames\n",
        "zip_filename = list(uploaded_zip.keys())[0]\n",
        "csv_filename = list(uploaded_csv.keys())[0]\n",
        "\n",
        "print(f\"\\nUploaded files:\")\n",
        "print(f\"  Zip: {zip_filename}\")\n",
        "print(f\"  CSV: {csv_filename}\")\n",
        "\n",
        "# Extract zip\n",
        "extract_to = 'vqa_rad_images/'\n",
        "with zipfile.ZipFile(zip_filename, 'r') as zip_ref:\n",
        "    zip_ref.extractall(extract_to)\n",
        "\n",
        "print(f\"\\nImages extracted to: {extract_to}\")\n",
        "print(\"Extraction complete! ✅\")"
      ],
      "metadata": {
        "id": "3V8_xWcBCvhK"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [],
      "metadata": {
        "id": "QGBdShUf6oBk"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Load CSV\n",
        "import os\n",
        "df = pd.read_csv(csv_filename)\n",
        "\n",
        "# Check structure\n",
        "print(f\"CSV loaded: {len(df)} rows\")\n",
        "print(f\"\\nColumns: {df.columns.tolist()}\")\n",
        "print(f\"\\nSample image names:\")\n",
        "print(df['image_name'].head())\n",
        "\n",
        "# Check extracted folder structure\n",
        "print(f\"\\nExtracted folder contents:\")\n",
        "for root, dirs, files in os.walk(extract_to):\n",
        "    print(f\"Folder: {root}\")\n",
        "    if files:\n",
        "        print(f\"Sample files: {files[:5]}\")\n",
        "    if dirs:\n",
        "        print(f\"Subfolders: {dirs}\")\n",
        "    break"
      ],
      "metadata": {
        "id": "UNsOGdW_D_DV"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Create full image paths\n",
        "df['full_image_path'] = df['image_name'].apply(lambda x: os.path.join(extract_to, x))\n",
        "\n",
        "# Verify images exist\n",
        "df['image_exists'] = df['full_image_path'].apply(os.path.exists)\n",
        "\n",
        "print(f\"Images found: {df['image_exists'].sum()} / {len(df)}\")\n",
        "print(f\"Missing images: {(~df['image_exists']).sum()}\")\n",
        "\n",
        "# Keep only valid samples\n",
        "df_valid = df[df['image_exists']].copy()\n",
        "\n",
        "print(f\"\\nValid dataset size: {len(df_valid)}\")\n",
        "print(f\"\\nQuestion types:\")\n",
        "print(df_valid['question_type'].value_counts())"
      ],
      "metadata": {
        "id": "7wNsB_DkEMjr"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Keep only essential columns\n",
        "columns_to_keep = [\n",
        "    'image_name',\n",
        "    'question',\n",
        "    'answer',\n",
        "    'question_type',\n",
        "    'answer_type',\n",
        "    'image_organ',\n",
        "    'split',\n",
        "    'full_image_path',\n",
        "    'image_exists'\n",
        "]\n",
        "\n",
        "df_valid = df_valid[columns_to_keep].copy()\n",
        "\n",
        "print(f\"Cleaned dataset columns: {df_valid.columns.tolist()}\")\n",
        "print(f\"Dataset size: {len(df_valid)}\")\n",
        "print(f\"\\nFirst few rows:\")\n",
        "print(df_valid.head())"
      ],
      "metadata": {
        "id": "UplQJeqAEnAT"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from sklearn.model_selection import train_test_split\n",
        "\n",
        "# Use existing split column\n",
        "train_df = df_valid[df_valid['split'] == 'Train'].reset_index(drop=True)\n",
        "test_df = df_valid[df_valid['split'] == 'Test'].reset_index(drop=True)\n",
        "\n",
        "print(f\"Original splits from CSV:\")\n",
        "print(f\"Train: {len(train_df)}\")\n",
        "print(f\"Test: {len(test_df)}\")\n",
        "\n",
        "# Create validation split from train (15%)\n",
        "train_df, val_df = train_test_split(\n",
        "    train_df,\n",
        "    test_size=0.15,\n",
        "    random_state=42,\n",
        "\n",
        ")\n",
        "\n",
        "print(f\"\\nFinal splits:\")\n",
        "print(f\"Train: {len(train_df)}\")\n",
        "print(f\"Val: {len(val_df)}\")\n",
        "print(f\"Test: {len(test_df)}\")"
      ],
      "metadata": {
        "id": "h9HHYqWAFVhz"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from torchvision import transforms\n",
        "\n",
        "# Define image preprocessing pipeline\n",
        "image_transform = transforms.Compose([\n",
        "    transforms.Resize((224, 224)),\n",
        "    transforms.ToTensor(),\n",
        "    transforms.Normalize(\n",
        "        mean=[0.485, 0.456, 0.406],\n",
        "        std=[0.229, 0.224, 0.225]\n",
        "    )\n",
        "])"
      ],
      "metadata": {
        "id": "cWf9unReC4mY"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from transformers import AutoTokenizer\n",
        "\n",
        "# Load Qwen3-4B tokenizer\n",
        "tokenizer = AutoTokenizer.from_pretrained(\n",
        "    \"Qwen/Qwen3-4B-Instruct-2507\",\n",
        "    trust_remote_code=True\n",
        ")\n",
        "\n",
        "# Add special image token\n",
        "special_tokens = {\"additional_special_tokens\": [\"<image>\"]}\n",
        "tokenizer.add_special_tokens(special_tokens)\n",
        "\n",
        "# Verify\n",
        "print(f\"Vocabulary size: {len(tokenizer)}\")\n",
        "print(f\"Image token ID: {tokenizer.convert_tokens_to_ids('<image>')}\")"
      ],
      "metadata": {
        "id": "Bu4JRduSDQyg"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from torch.utils.data import Dataset\n",
        "\n",
        "class VQADataset(Dataset):\n",
        "    def __init__(self, df, tokenizer, image_transform, max_length=128):\n",
        "        self.df = df.reset_index(drop=True)\n",
        "        self.tokenizer = tokenizer\n",
        "        self.image_transform = image_transform\n",
        "        self.max_length = max_length\n",
        "\n",
        "    def __len__(self):\n",
        "        return len(self.df)\n",
        "\n",
        "    def __getitem__(self, idx):\n",
        "        row = self.df.iloc[idx]\n",
        "\n",
        "        # Load image from path\n",
        "        image = Image.open(row['full_image_path']).convert('RGB')\n",
        "        image = self.image_transform(image)\n",
        "\n",
        "        # Get question and answer\n",
        "        question = row['question']\n",
        "        answer = row['answer']\n",
        "\n",
        "        # Create full text: \"<image>\\nQuestion: {question}\\nAnswer: {answer}\"\n",
        "        full_text = f\"<image>\\nQuestion: {question}\\nAnswer: {answer}\"\n",
        "\n",
        "        # Tokenize\n",
        "        tokens = self.tokenizer(\n",
        "            full_text,\n",
        "            max_length=self.max_length,\n",
        "            padding='max_length',\n",
        "            truncation=True,\n",
        "            return_tensors='pt'\n",
        "        )\n",
        "\n",
        "        return {\n",
        "            'image': image,\n",
        "            'input_ids': tokens['input_ids'].squeeze(0),\n",
        "            'attention_mask': tokens['attention_mask'].squeeze(0),\n",
        "            'labels': tokens['input_ids'].squeeze(0),\n",
        "            'answer_text': answer,\n",
        "            'question_type': row['question_type'],\n",
        "            'answer_type': row['answer_type'],\n",
        "            'image_organ': row['image_organ']\n",
        "        }\n",
        "batch_size = 4\n",
        "# Create VQADataset instances\n",
        "train_dataset = VQADataset(train_df, tokenizer, image_transform)\n",
        "val_dataset = VQADataset(val_df, tokenizer, image_transform)\n",
        "test_dataset = VQADataset(test_df, tokenizer, image_transform)\n",
        "\n",
        "# Create DataLoaders\n",
        "train_loader = DataLoader(train_dataset, batch_size=batch_size, shuffle=True)\n",
        "val_loader = DataLoader(val_dataset, batch_size=batch_size, shuffle=False)\n",
        "test_loader = DataLoader(test_dataset, batch_size=batch_size, shuffle=False)\n",
        "\n",
        "print(f\"Datasets created:\")\n",
        "print(f\"Train: {len(train_dataset)} samples\")\n",
        "print(f\"Val: {len(val_dataset)} samples\")\n",
        "print(f\"Test: {len(test_dataset)} samples\")"
      ],
      "metadata": {
        "id": "HavH8eWEDi-_"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Install if needed\n",
        "!pip install open_clip_torch"
      ],
      "metadata": {
        "id": "ta664zS_vFll"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "\n",
        "\n",
        "import open_clip\n",
        "\n",
        "model, preprocess = open_clip.create_model_from_pretrained(\n",
        "    'hf-hub:microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224'\n",
        ")\n",
        "vision_encoder = model.visual  # Extract vision encoder only"
      ],
      "metadata": {
        "id": "wrLJqWZWuUz2"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Freeze all parameters\n",
        "for param in vision_encoder.parameters():\n",
        "    param.requires_grad = False\n",
        "\n",
        "# Move to device\n",
        "vision_encoder = vision_encoder.to(device)\n",
        "vision_encoder.eval()\n",
        "\n",
        "# Verify\n",
        "print(f\"Vision encoder loaded\")\n",
        "print(f\"Parameters frozen: {not next(vision_encoder.parameters()).requires_grad}\")\n",
        "print(f\"Device: {next(vision_encoder.parameters()).device}\")"
      ],
      "metadata": {
        "id": "f5Cdtrhkv0Ja"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Check for the correct attribute\n",
        "if hasattr(vision_encoder, 'embed_dim'):\n",
        "    print(f\"Output dimension: {vision_encoder.embed_dim}\")\n",
        "elif hasattr(vision_encoder, 'num_features'):\n",
        "    print(f\"Output dimension: {vision_encoder.num_features}\")\n",
        "else:\n",
        "    # Test with dummy input\n",
        "    dummy_input = torch.randn(1, 3, 224, 224).to(device)\n",
        "    with torch.no_grad():\n",
        "        output = vision_encoder(dummy_input)\n",
        "    print(f\"Output dimension: {output.shape[-1]}\")"
      ],
      "metadata": {
        "id": "uy6aQ2XTvXGb"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Get a sample from train dataset\n",
        "row_idx = 0 # Example row index\n",
        "sample = train_df.iloc[row_idx]\n",
        "image = Image.open(sample['full_image_path']).convert('RGB') # Load image using full_image_path\n",
        "\n",
        "# Apply preprocessing\n",
        "image_tensor = image_transform(image).unsqueeze(0).to(device)  # Add batch dimension\n",
        "\n",
        "# Extract features\n",
        "with torch.no_grad():\n",
        "    features = vision_encoder(image_tensor)\n",
        "\n",
        "print(f\"Input image shape: {image_tensor.shape}\")\n",
        "print(f\"Output features shape: {features.shape}\")\n",
        "print(f\"Feature sample (first 10 values): {features[0, :10]}\")\n",
        "\n",
        "# Visualize the image\n",
        "plt.imshow(image)\n",
        "plt.title(f\"Q: {sample['question']}\\nA: {sample['answer']}\")\n",
        "plt.axis('off')\n",
        "plt.show()"
      ],
      "metadata": {
        "id": "AW1Agm6MwH27"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "import torch.nn as nn\n",
        "\n",
        "class Projector(nn.Module):\n",
        "    def __init__(self, vision_dim=512, llm_dim=2560, hidden_dim=2048):\n",
        "        super().__init__()\n",
        "        self.linear1 = nn.Linear(vision_dim, hidden_dim)\n",
        "        self.gelu1 = nn.GELU()\n",
        "        self.linear2 = nn.Linear(hidden_dim, hidden_dim)\n",
        "        self.gelu2 = nn.GELU()\n",
        "        self.linear3 = nn.Linear(hidden_dim, llm_dim)\n",
        "\n",
        "\n",
        "    def forward(self, x):\n",
        "        x = self.gelu1(self.linear1(x))\n",
        "        x = self.gelu2(self.linear2(x))\n",
        "        x = self.linear3(x)\n",
        "        return x\n",
        "\n",
        "# Create projector\n",
        "projector = Projector(vision_dim=512, llm_dim=2560, hidden_dim=2048)\n",
        "projector = projector.to(device)\n",
        "\n",
        "print(f\"Projector created\")\n",
        "print(f\"Trainable parameters: {sum(p.numel() for p in projector.parameters()):,}\")"
      ],
      "metadata": {
        "id": "FwePow4qwaiB"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from transformers import AutoModelForCausalLM, BitsAndBytesConfig\n",
        "from peft import LoraConfig, get_peft_model\n",
        "\n",
        "# 4-bit quantization config\n",
        "bnb_config = BitsAndBytesConfig(\n",
        "    load_in_4bit=True,\n",
        "    bnb_4bit_quant_type=\"nf4\",\n",
        "    bnb_4bit_compute_dtype=torch.float16,\n",
        "    bnb_4bit_use_double_quant=True\n",
        ")\n",
        "\n",
        "# Load LLM\n",
        "llm = AutoModelForCausalLM.from_pretrained(\n",
        "    \"Qwen/Qwen3-4B-Instruct-2507\",\n",
        "    quantization_config=bnb_config,\n",
        "    device_map=\"auto\",\n",
        "    trust_remote_code=True\n",
        ")\n",
        "\n",
        "# LoRA config\n",
        "lora_config = LoraConfig(\n",
        "    r=16,\n",
        "    lora_alpha=32,\n",
        "    target_modules=[\"q_proj\", \"v_proj\"],\n",
        "    lora_dropout=0.05,\n",
        "    bias=\"none\",\n",
        "    task_type=\"CAUSAL_LM\"\n",
        ")\n",
        "\n",
        "# Apply LoRA\n",
        "llm = get_peft_model(llm, lora_config)\n",
        "\n",
        "print(\"LLM loaded with LoRA\")\n",
        "llm.print_trainable_parameters()"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 400,
          "referenced_widgets":
        },
        "id": "gClOzhMwwg1O",
        "outputId": "cbed3843-05b8-4cf3-fb9c-7d9be9b0b31c"
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "/usr/local/lib/python3.12/dist-packages/huggingface_hub/utils/_auth.py:94: UserWarning: \n",
            "The secret `HF_TOKEN` does not exist in your Colab secrets.\n",
            "To authenticate with the Hugging Face Hub, create a token in your settings tab (https://huggingface.co/settings/tokens), set it as secret in your Google Colab and restart your session.\n",
            "You will be able to reuse this secret in all of your notebooks.\n",
            "Please note that authentication is recommended but still optional to access public models or datasets.\n",
            "  warnings.warn(\n"
          ]
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "model.safetensors.index.json: 0.00B [00:00, ?B/s]"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "b6a1979f02924464999974093afc5d93"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "Fetching 3 files:   0%|          | 0/3 [00:00<?, ?it/s]"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "3038b6a6961640b1ad92f19187b3f795"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "model-00001-of-00003.safetensors:   0%|          | 0.00/3.96G [00:00<?, ?B/s]"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "2cde100b345b48ddb235142138469af3"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "model-00003-of-00003.safetensors:   0%|          | 0.00/99.6M [00:00<?, ?B/s]"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "d62445c75dfc497b9b2bb3affa8eb6e3"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "model-00002-of-00003.safetensors:   0%|          | 0.00/3.99G [00:00<?, ?B/s]"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "40565222ac3e4ab58a72bb867c2007cc"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "Loading checkpoint shards:   0%|          | 0/3 [00:00<?, ?it/s]"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "95007928a678454aaaecd4e8e8f34d78"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "generation_config.json:   0%|          | 0.00/238 [00:00<?, ?B/s]"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "e9577dbffc5d403f8e05c030262b998c"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "LLM loaded with LoRA\n",
            "trainable params: 5,898,240 || all params: 4,028,366,336 || trainable%: 0.1464\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "# Check the native context window\n",
        "print(f\"Max Context Window: {llm.config.max_position_embeddings} tokens\")"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "Iwki8nYpimMc",
        "outputId": "74cc5e1a-e237-46c0-b565-41550b5d908d"
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Max Context Window: 262144 tokens\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "class VLMModel(nn.Module):\n",
        "    def __init__(self, vision_encoder, projector, llm, tokenizer):\n",
        "        super().__init__()\n",
        "        self.vision_encoder = vision_encoder\n",
        "        self.projector = projector\n",
        "        self.llm = llm\n",
        "        self.tokenizer = tokenizer\n",
        "        self.image_token_id = tokenizer.convert_tokens_to_ids('<image>')\n",
        "\n",
        "    def forward(self, images, input_ids, attention_mask, labels=None):\n",
        "        # Extract visual features\n",
        "        with torch.no_grad():\n",
        "            visual_features = self.vision_encoder(images)  # [batch, 512]\n",
        "\n",
        "        # Project to LLM embedding space\n",
        "        visual_embeds = self.projector(visual_features)  # [batch, 1536]\n",
        "        visual_embeds = visual_embeds.unsqueeze(1)  # [batch, 1, 1536]\n",
        "\n",
        "        # Get text embeddings\n",
        "        text_embeds = self.llm.get_input_embeddings()(input_ids)  # [batch, seq_len, 1536]\n",
        "\n",
        "        # Find <image> token positions and replace with visual embeddings\n",
        "        batch_size = input_ids.shape[0]\n",
        "        for i in range(batch_size):\n",
        "            image_pos = (input_ids[i] == self.image_token_id).nonzero(as_tuple=True)[0]\n",
        "            if len(image_pos) > 0:\n",
        "                text_embeds[i, image_pos[0]] = visual_embeds[i, 0]\n",
        "\n",
        "        # Forward through LLM - don't pass labels, compute loss manually\n",
        "        outputs = self.llm(\n",
        "            inputs_embeds=text_embeds,\n",
        "            attention_mask=attention_mask\n",
        "        )\n",
        "\n",
        "        # Manually compute loss if labels provided\n",
        "        loss = None\n",
        "        if labels is not None:\n",
        "            logits = outputs.logits\n",
        "            # Shift for causal LM: predict next token\n",
        "            shift_logits = logits[..., :-1, :].contiguous()\n",
        "            shift_labels = labels[..., 1:].contiguous()\n",
        "\n",
        "            loss_fct = nn.CrossEntropyLoss(ignore_index=tokenizer.pad_token_id)\n",
        "            loss = loss_fct(shift_logits.view(-1, shift_logits.size(-1)), shift_labels.view(-1))\n",
        "\n",
        "            # Create outputs with loss\n",
        "            from transformers.modeling_outputs import CausalLMOutputWithPast\n",
        "            outputs = CausalLMOutputWithPast(loss=loss, logits=logits)\n",
        "\n",
        "        return outputs\n",
        "\n",
        "# Recreate VLM with fixed forward\n",
        "vlm_model = VLMModel(vision_encoder, projector, llm, tokenizer)\n",
        "print(\"VLM model recreated with fix\")"
      ],
      "metadata": {
        "id": "KYw1mU3szK0K"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from torch.optim import AdamW\n",
        "\n",
        "# Get trainable parameters (projector + LoRA)\n",
        "trainable_params = [\n",
        "    {'params': projector.parameters(), 'lr': 1e-4},\n",
        "    {'params': llm.parameters(), 'lr': 5e-5}\n",
        "]\n",
        "\n",
        "# Create optimizer\n",
        "optimizer = AdamW(trainable_params, weight_decay=0.01)\n",
        "\n",
        "# Training config\n",
        "num_epochs =3\n",
        "gradient_accumulation_steps = 4  # Effective batch = 4 * 4 = 16\n",
        "\n",
        "print(f\"Optimizer created\")\n",
        "print(f\"Epochs: {num_epochs}\")\n",
        "print(f\"Effective batch size: {batch_size * gradient_accumulation_steps}\")"
      ],
      "metadata": {
        "id": "v_lldYjzzRW8"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from tqdm import tqdm\n",
        "\n",
        "def train_epoch(model, train_loader, optimizer, device, gradient_accumulation_steps):\n",
        "    model.train()\n",
        "    total_loss = 0\n",
        "    optimizer.zero_grad()\n",
        "\n",
        "    progress_bar = tqdm(train_loader, desc=\"Training\")\n",
        "\n",
        "    for step, batch in enumerate(progress_bar):\n",
        "        # Move batch to device\n",
        "        images = batch['image'].to(device)\n",
        "        input_ids = batch['input_ids'].to(device)\n",
        "        attention_mask = batch['attention_mask'].to(device)\n",
        "        labels = batch['labels'].to(device)\n",
        "\n",
        "        # Forward pass\n",
        "        outputs = model(images, input_ids, attention_mask, labels)\n",
        "        loss = outputs.loss / gradient_accumulation_steps\n",
        "\n",
        "        # Backward pass\n",
        "        loss.backward()\n",
        "\n",
        "        # Update weights every gradient_accumulation_steps\n",
        "        if (step + 1) % gradient_accumulation_steps == 0:\n",
        "            optimizer.step()\n",
        "            optimizer.zero_grad()\n",
        "\n",
        "        total_loss += loss.item() * gradient_accumulation_steps\n",
        "        progress_bar.set_postfix({'loss': f'{loss.item() * gradient_accumulation_steps:.4f}'})\n",
        "\n",
        "    return total_loss / len(train_loader)\n",
        "\n",
        "print(\"Training function ready\")"
      ],
      "metadata": {
        "id": "FQB6rOvNDpku"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "def validate(model, val_loader, device):\n",
        "    model.eval()\n",
        "    total_loss = 0\n",
        "\n",
        "    progress_bar = tqdm(val_loader, desc=\"Validation\")\n",
        "\n",
        "    with torch.no_grad():\n",
        "        for batch in progress_bar:\n",
        "            # Move batch to device\n",
        "            images = batch['image'].to(device)\n",
        "            input_ids = batch['input_ids'].to(device)\n",
        "            attention_mask = batch['attention_mask'].to(device)\n",
        "            labels = batch['labels'].to(device)\n",
        "\n",
        "            # Forward pass\n",
        "            outputs = model(images, input_ids, attention_mask, labels)\n",
        "            loss = outputs.loss\n",
        "\n",
        "            total_loss += loss.item()\n",
        "            progress_bar.set_postfix({'loss': f'{loss.item():.4f}'})\n",
        "\n",
        "    return total_loss / len(val_loader)\n",
        "\n",
        "print(\"Validation function ready\")"
      ],
      "metadata": {
        "id": "m5sH4P26EUMw"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Training history\n",
        "train_losses = []\n",
        "val_losses = []\n",
        "\n",
        "print(\"Starting training...\")\n",
        "\n",
        "for epoch in range(num_epochs):\n",
        "    print(f\"\\n{'='*50}\")\n",
        "    print(f\"Epoch {epoch + 1}/{num_epochs}\")\n",
        "    print(f\"{'='*50}\")\n",
        "\n",
        "    # Train\n",
        "    train_loss = train_epoch(vlm_model, train_loader, optimizer, device, gradient_accumulation_steps)\n",
        "    train_losses.append(train_loss)\n",
        "\n",
        "    # Validate\n",
        "    val_loss = validate(vlm_model, val_loader, device)\n",
        "    val_losses.append(val_loss)\n",
        "\n",
        "    print(f\"\\nEpoch {epoch + 1} Summary:\")\n",
        "    print(f\"Train Loss: {train_loss:.4f}\")\n",
        "    print(f\"Val Loss: {val_loss:.4f}\")\n",
        "\n",
        "print(\"\\nTraining complete!\")"
      ],
      "metadata": {
        "id": "ljKyh4UlEu5g"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [],
      "metadata": {
        "id": "MZd605CdyRdA"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "def generate_answer(model, image, question, tokenizer, device, max_length=15):\n",
        "    model.eval()\n",
        "\n",
        "    image_tensor = image_transform(image).unsqueeze(0).to(device)\n",
        "    prompt = f\"<image>\\nQuestion: {question}\\nAnswer:\"\n",
        "\n",
        "    inputs = tokenizer(prompt, return_tensors='pt', padding=True)\n",
        "    input_ids = inputs['input_ids'].to(device)\n",
        "    attention_mask = inputs['attention_mask'].to(device)\n",
        "\n",
        "    with torch.no_grad():\n",
        "        visual_features = model.vision_encoder(image_tensor)\n",
        "        visual_embeds = model.projector(visual_features).unsqueeze(1)\n",
        "\n",
        "        text_embeds = model.llm.get_input_embeddings()(input_ids)\n",
        "        image_pos = (input_ids[0] == model.image_token_id).nonzero(as_tuple=True)[0]\n",
        "        if len(image_pos) > 0:\n",
        "            text_embeds[0, image_pos[0]] = visual_embeds[0, 0]\n",
        "\n",
        "        outputs = model.llm.generate(\n",
        "            inputs_embeds=text_embeds,\n",
        "            attention_mask=attention_mask,\n",
        "            max_new_tokens=10,  # ← Changed from 50 to 10\n",
        "            min_new_tokens=1,\n",
        "            pad_token_id=tokenizer.pad_token_id,\n",
        "            eos_token_id=tokenizer.eos_token_id,\n",
        "            do_sample=False,  # Greedy decoding\n",
        "            temperature=1.0,\n",
        "            repetition_penalty=1.2  # Prevent loops\n",
        "        )\n",
        "\n",
        "    answer = tokenizer.decode(outputs[0], skip_special_tokens=True)\n",
        "    answer = answer.split(\"Answer:\")[-1].strip()\n",
        "\n",
        "    # Truncate at first period or newline for closed-ended\n",
        "    answer = answer.split('.')[0].split('\\n')[0].strip()\n",
        "\n",
        "    return answer"
      ],
      "metadata": {
        "id": "wDp9vuAkFlW9"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Get a test sample\n",
        "original_test_idx = 15 # Using the first sample from the test_dataset for consistency\n",
        "\n",
        "# Get the full row from the original test_df to access the path\n",
        "# This ensures we get the original PIL Image for generate_answer and display\n",
        "row_from_test_df = test_df.iloc[original_test_idx]\n",
        "test_image_pil = Image.open(row_from_test_df['full_image_path']).convert('RGB')\n",
        "\n",
        "# Extract question and ground truth from the dataframe row\n",
        "test_question = row_from_test_df['question']\n",
        "ground_truth = row_from_test_df['answer']\n",
        "\n",
        "# Generate prediction using the PIL image\n",
        "predicted_answer = generate_answer(\n",
        "    vlm_model,\n",
        "    test_image_pil, # Pass the PIL image here\n",
        "    test_question,\n",
        "    tokenizer,\n",
        "    device\n",
        ")\n",
        "\n",
        "# Display results using the PIL image\n",
        "plt.imshow(test_image_pil)\n",
        "plt.axis('off')\n",
        "plt.title(f\"Question: {test_question}\", fontsize=10)\n",
        "plt.show()\n",
        "\n",
        "print(f\"Ground Truth: {ground_truth}\")\n",
        "print(f\"Predicted: {predicted_answer}\")"
      ],
      "metadata": {
        "id": "mBteUVztQOC8"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Get a test sample\n",
        "original_test_idx = 5 # Using the first sample from the test_dataset for consistency\n",
        "\n",
        "# Get the full row from the original test_df to access the path\n",
        "# This ensures we get the original PIL Image for generate_answer and display\n",
        "row_from_test_df = test_df.iloc[original_test_idx]\n",
        "test_image_pil = Image.open(row_from_test_df['full_image_path']).convert('RGB')\n",
        "\n",
        "# Extract question and ground truth from the dataframe row\n",
        "test_question = row_from_test_df['question']\n",
        "ground_truth = row_from_test_df['answer']\n",
        "\n",
        "# Generate prediction using the PIL image\n",
        "predicted_answer = generate_answer(\n",
        "    vlm_model,\n",
        "    test_image_pil, # Pass the PIL image here\n",
        "    test_question,\n",
        "    tokenizer,\n",
        "    device\n",
        ")\n",
        "\n",
        "# Display results using the PIL image\n",
        "plt.imshow(test_image_pil)\n",
        "plt.axis('off')\n",
        "plt.title(f\"Question: {test_question}\", fontsize=10)\n",
        "plt.show()\n",
        "\n",
        "print(f\"Ground Truth: {ground_truth}\")\n",
        "print(f\"Predicted: {predicted_answer}\")"
      ],
      "metadata": {
        "id": "fkW41FXY12AY"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Get a test sample\n",
        "original_test_idx = 25 # Using the first sample from the test_dataset for consistency\n",
        "\n",
        "# Get the full row from the original test_df to access the path\n",
        "# This ensures we get the original PIL Image for generate_answer and display\n",
        "row_from_test_df = test_df.iloc[original_test_idx]\n",
        "test_image_pil = Image.open(row_from_test_df['full_image_path']).convert('RGB')\n",
        "\n",
        "# Extract question and ground truth from the dataframe row\n",
        "test_question = row_from_test_df['question']\n",
        "ground_truth = row_from_test_df['answer']\n",
        "\n",
        "# Generate prediction using the PIL image\n",
        "predicted_answer = generate_answer(\n",
        "    vlm_model,\n",
        "    test_image_pil, # Pass the PIL image here\n",
        "    test_question,\n",
        "    tokenizer,\n",
        "    device\n",
        ")\n",
        "\n",
        "# Display results using the PIL image\n",
        "plt.imshow(test_image_pil)\n",
        "plt.axis('off')\n",
        "plt.title(f\"Question: {test_question}\", fontsize=10)\n",
        "plt.show()\n",
        "\n",
        "print(f\"Ground Truth: {ground_truth}\")\n",
        "print(f\"Predicted: {predicted_answer}\")"
      ],
      "metadata": {
        "id": "10MxPjqi14au"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Get a test sample\n",
        "original_test_idx = 35 # Using the first sample from the test_dataset for consistency\n",
        "\n",
        "# Get the full row from the original test_df to access the path\n",
        "# This ensures we get the original PIL Image for generate_answer and display\n",
        "row_from_test_df = test_df.iloc[original_test_idx]\n",
        "test_image_pil = Image.open(row_from_test_df['full_image_path']).convert('RGB')\n",
        "\n",
        "# Extract question and ground truth from the dataframe row\n",
        "test_question = row_from_test_df['question']\n",
        "ground_truth = row_from_test_df['answer']\n",
        "\n",
        "# Generate prediction using the PIL image\n",
        "predicted_answer = generate_answer(\n",
        "    vlm_model,\n",
        "    test_image_pil, # Pass the PIL image here\n",
        "    test_question,\n",
        "    tokenizer,\n",
        "    device\n",
        ")\n",
        "\n",
        "# Display results using the PIL image\n",
        "plt.imshow(test_image_pil)\n",
        "plt.axis('off')\n",
        "plt.title(f\"Question: {test_question}\", fontsize=10)\n",
        "plt.show()\n",
        "\n",
        "print(f\"Ground Truth: {ground_truth}\")\n",
        "print(f\"Predicted: {predicted_answer}\")"
      ],
      "metadata": {
        "id": "jIO8mj4u16hH"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# After training completes, calculate test loss\n",
        "def compute_test_loss(model, test_loader, device):\n",
        "    model.eval()\n",
        "    total_loss = 0\n",
        "\n",
        "    with torch.no_grad():\n",
        "        for batch in tqdm(test_loader, desc=\"Computing Test Loss\"):\n",
        "            images = batch['image'].to(device)\n",
        "            input_ids = batch['input_ids'].to(device)\n",
        "            attention_mask = batch['attention_mask'].to(device)\n",
        "            labels = batch['labels'].to(device)\n",
        "\n",
        "            outputs = model(images, input_ids, attention_mask, labels)\n",
        "            loss = outputs.loss\n",
        "            total_loss += loss.item()\n",
        "\n",
        "    return total_loss / len(test_loader)\n",
        "\n",
        "# Calculate test loss\n",
        "test_loss = compute_test_loss(vlm_model, test_loader, device)\n",
        "\n",
        "print(f\"\\nFinal Loss Comparison:\")\n",
        "print(f\"Final Train Loss: {train_losses[-1]:.4f}\")\n",
        "print(f\"Final Val Loss: {val_losses[-1]:.4f}\")\n",
        "print(f\"Test Loss: {test_loss:.4f}\")\n",
        "\n",
        "# Plot all three\n",
        "plt.figure(figsize=(12, 6))\n",
        "\n",
        "# Training and validation over epochs\n",
        "epochs = range(1, num_epochs + 1)\n",
        "plt.plot(epochs, train_losses, marker='o', label='Training Loss', linewidth=2)\n",
        "plt.plot(epochs, val_losses, marker='s', label='Validation Loss', linewidth=2)\n",
        "\n",
        "# Test loss as horizontal line (computed once)\n",
        "plt.axhline(y=test_loss, color='red', linestyle='--', linewidth=2, label='Test Loss')\n",
        "\n",
        "plt.xlabel('Epoch', fontsize=12)\n",
        "plt.ylabel('Loss', fontsize=12)\n",
        "plt.title('Training, Validation, and Test Loss', fontsize=14)\n",
        "plt.legend(fontsize=11)\n",
        "plt.grid(True, alpha=0.3)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ],
      "metadata": {
        "id": "RfKwzf-IhhLW"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "!pip install rouge-score"
      ],
      "metadata": {
        "id": "AhSPwaP4HhMl"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from nltk.translate.bleu_score import sentence_bleu, SmoothingFunction\n",
        "from rouge_score import rouge_scorer\n",
        "import numpy as np\n",
        "\n",
        "def evaluate_comprehensive(model, test_df, tokenizer, device):\n",
        "    \"\"\"\n",
        "    Single-pass evaluation with all metrics:\n",
        "    - Overall accuracy by question type\n",
        "    - Closed-ended: Accuracy\n",
        "    - Open-ended: Exact Match, BLEU-4, ROUGE-L\n",
        "    \"\"\"\n",
        "    results = {\n",
        "        'closed': {'predictions': [], 'ground_truths': []},\n",
        "        'open': {'predictions': [], 'ground_truths': []},\n",
        "        'all': []  # For question type breakdown\n",
        "    }\n",
        "\n",
        "    # Generate all predictions (SINGLE PASS)\n",
        "    for idx in tqdm(range(len(test_df)), desc=\"Evaluating\"):\n",
        "        row = test_df.iloc[idx]\n",
        "\n",
        "        # Load image and generate prediction\n",
        "        image = Image.open(row['full_image_path']).convert('RGB')\n",
        "        pred = generate_answer(model, image, row['question'], tokenizer, device)\n",
        "\n",
        "        pred_clean = pred.lower().strip()\n",
        "        gt_clean = row['answer'].lower().strip()\n",
        "\n",
        "        # Store for question type analysis\n",
        "        results['all'].append({\n",
        "            'prediction': pred_clean.split()[0] if pred_clean.split() else \"\",\n",
        "            'prediction_full': pred_clean,  # Keep full for open-ended\n",
        "            'ground_truth': gt_clean,\n",
        "            'question_type': row['question_type'],\n",
        "            'answer_type': row['answer_type'],\n",
        "            'organ': row['image_organ']\n",
        "        })\n",
        "\n",
        "        # Separate by answer type\n",
        "        if row['answer_type'] == 'CLOSED':\n",
        "            results['closed']['predictions'].append(pred_clean)\n",
        "            results['closed']['ground_truths'].append(gt_clean)\n",
        "        else:  # OPEN\n",
        "            results['open']['predictions'].append(pred_clean)\n",
        "            results['open']['ground_truths'].append(gt_clean)\n",
        "\n",
        "    # Convert to DataFrame for analysis\n",
        "    df_results = pd.DataFrame(results['all'])\n",
        "\n",
        "    # ===== OVERALL ACCURACY =====\n",
        "    overall_correct = (df_results['prediction'] == df_results['ground_truth']).sum()\n",
        "    overall_acc = overall_correct / len(df_results) * 100\n",
        "\n",
        "    # ===== CLOSED-ENDED ACCURACY =====\n",
        "    closed_correct = 0\n",
        "    for pred, gt in zip(results['closed']['predictions'], results['closed']['ground_truths']):\n",
        "        pred_word = pred.split()[0] if pred.split() else \"\"\n",
        "        gt_word = gt.split()[0] if gt.split() else \"\"\n",
        "        if pred_word == gt_word:\n",
        "            closed_correct += 1\n",
        "\n",
        "    closed_acc = (closed_correct / len(results['closed']['predictions']) * 100) if results['closed']['predictions'] else 0\n",
        "\n",
        "    # ===== OPEN-ENDED METRICS =====\n",
        "    open_exact = []\n",
        "    open_bleu4 = []\n",
        "    open_rouge_l = []\n",
        "\n",
        "    rouge_scorer_obj = rouge_scorer.RougeScorer(['rougeL'], use_stemmer=True)\n",
        "    smoothing = SmoothingFunction()\n",
        "\n",
        "    for pred, gt in zip(results['open']['predictions'], results['open']['ground_truths']):\n",
        "        # Exact Match\n",
        "        exact = 1.0 if pred == gt else 0.0\n",
        "        open_exact.append(exact)\n",
        "\n",
        "        # Tokenize\n",
        "        pred_tokens = pred.split()\n",
        "        gt_tokens = gt.split()\n",
        "\n",
        "        # BLEU-4\n",
        "        if len(pred_tokens) > 0 and len(gt_tokens) > 0:\n",
        "            bleu4 = sentence_bleu(\n",
        "                [gt_tokens],\n",
        "                pred_tokens,\n",
        "                weights=(0.25, 0.25, 0.25, 0.25),\n",
        "                smoothing_function=smoothing.method1\n",
        "            )\n",
        "        else:\n",
        "            bleu4 = 0.0\n",
        "        open_bleu4.append(bleu4)\n",
        "\n",
        "        # ROUGE-L\n",
        "        rouge_scores = rouge_scorer_obj.score(gt, pred)\n",
        "        open_rouge_l.append(rouge_scores['rougeL'].fmeasure)\n",
        "\n",
        "    # Calculate averages\n",
        "    open_exact_avg = np.mean(open_exact) * 100 if open_exact else 0\n",
        "    open_bleu4_avg = np.mean(open_bleu4) * 100 if open_bleu4 else 0\n",
        "    open_rouge_l_avg = np.mean(open_rouge_l) * 100 if open_rouge_l else 0\n",
        "\n",
        "    # ===== PRINT RESULTS =====\n",
        "    print(\"\\n\" + \"=\"*70)\n",
        "    print(\" \" * 20 + \"EVALUATION RESULTS\")\n",
        "    print(\"=\"*70)\n",
        "\n",
        "    print(f\"\\n📊 OVERALL PERFORMANCE:\")\n",
        "    print(f\"   Accuracy: {overall_acc:.2f}% ({overall_correct}/{len(df_results)})\")\n",
        "\n",
        "    print(f\"\\n📊 BY ANSWER TYPE:\")\n",
        "    print(f\"   Closed-ended ({len(results['closed']['predictions'])} samples):\")\n",
        "    print(f\"      Accuracy: {closed_acc:.2f}% ({closed_correct}/{len(results['closed']['predictions'])})\")\n",
        "\n",
        "    print(f\"\\n   Open-ended ({len(results['open']['predictions'])} samples):\")\n",
        "    print(f\"      Exact Match:  {open_exact_avg:.2f}%\")\n",
        "    print(f\"      BLEU-4:       {open_bleu4_avg:.2f}%\")\n",
        "    print(f\"      ROUGE-L:      {open_rouge_l_avg:.2f}%\")\n",
        "\n",
        "    print(f\"\\n📊 BY QUESTION TYPE:\")\n",
        "    for qtype in df_results['question_type'].value_counts().index[:10]:\n",
        "        mask = df_results['question_type'] == qtype\n",
        "        correct = (df_results[mask]['prediction'] == df_results[mask]['ground_truth']).sum()\n",
        "        total = mask.sum()\n",
        "        acc = correct / total * 100\n",
        "        print(f\"   {qtype:15s}: {acc:5.2f}% ({correct}/{total})\")\n",
        "\n",
        "    print(\"\\n\" + \"=\"*70)\n",
        "\n",
        "    return {\n",
        "        'overall_acc': overall_acc,\n",
        "        'closed_acc': closed_acc,\n",
        "        'open_exact': open_exact_avg,\n",
        "        'open_bleu4': open_bleu4_avg,\n",
        "        'open_rouge_l': open_rouge_l_avg,\n",
        "        'df_results': df_results,\n",
        "        'results': results\n",
        "    }\n",
        "\n",
        "# Run complete evaluation ONCE\n",
        "metrics = evaluate_comprehensive(vlm_model, test_df, tokenizer, device)"
      ],
      "metadata": {
        "id": "vn-xrLyCoCDW"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "from nltk.translate.bleu_score import sentence_bleu, SmoothingFunction\n",
        "from rouge_score import rouge_scorer\n",
        "import numpy as np\n",
        "from tqdm import tqdm\n",
        "from PIL import Image"
      ],
      "metadata": {
        "id": "YKkvoGVaTlwn"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "import re\n",
        "\n",
        "\n",
        "def clean_closed_answer(pred):\n",
        "    \"\"\"\n",
        "    Extract yes/no from potentially verbose answers.\n",
        "    Handles cases like \"Yes, there is...\", \"No signs of...\", etc.\n",
        "    \"\"\"\n",
        "    pred = pred.lower().strip()\n",
        "\n",
        "    # Match \"yes\" at start of string (with word boundary)\n",
        "    if re.match(r'^yes\\b', pred):\n",
        "        return \"yes\"\n",
        "\n",
        "    # Match \"no\" at start of string (with word boundary)\n",
        "    if re.match(r'^no\\b', pred):\n",
        "        return \"no\"\n",
        "\n",
        "    # If no clear yes/no pattern, return first word as fallback\n",
        "    return pred.split()[0] if pred.split() else \"\"\n",
        "\n",
        "\n",
        "def evaluate_comprehensive(model, test_df, tokenizer, device):\n",
        "    \"\"\"\n",
        "    Single-pass evaluation with all metrics:\n",
        "    - Overall accuracy by question type\n",
        "    - Closed-ended: Accuracy (with regex cleaning)\n",
        "    - Open-ended: Exact Match, BLEU-4, ROUGE-L\n",
        "    \"\"\"\n",
        "    results = {\n",
        "        'closed': {'predictions': [], 'ground_truths': []},\n",
        "        'open': {'predictions': [], 'ground_truths': []},\n",
        "        'all': []  # For question type breakdown\n",
        "    }\n",
        "\n",
        "    # Generate all predictions (SINGLE PASS)\n",
        "    for idx in tqdm(range(len(test_df)), desc=\"Evaluating\"):\n",
        "        row = test_df.iloc[idx]\n",
        "\n",
        "        # Load image and generate prediction\n",
        "        image = Image.open(row['full_image_path']).convert('RGB')\n",
        "        pred = generate_answer(model, image, row['question'], tokenizer, device)\n",
        "\n",
        "        pred_clean = pred.lower().strip()\n",
        "        gt_clean = row['answer'].lower().strip()\n",
        "\n",
        "        # For closed-ended, use regex cleaning\n",
        "        if row['answer_type'] == 'CLOSED':\n",
        "            pred_for_comparison = clean_closed_answer(pred_clean)\n",
        "            gt_for_comparison = clean_closed_answer(gt_clean)\n",
        "        else:\n",
        "            # For open-ended, keep first word for overall accuracy\n",
        "            pred_for_comparison = pred_clean.split()[0] if pred_clean.split() else \"\"\n",
        "            gt_for_comparison = gt_clean.split()[0] if gt_clean.split() else \"\"\n",
        "\n",
        "        # Store for question type analysis\n",
        "        results['all'].append({\n",
        "            'prediction': pred_for_comparison,\n",
        "            'prediction_full': pred_clean,  # Keep full for open-ended metrics\n",
        "            'ground_truth': gt_for_comparison,\n",
        "            'ground_truth_full': gt_clean,\n",
        "            'question_type': row['question_type'],\n",
        "            'answer_type': row['answer_type'],\n",
        "            'organ': row['image_organ']\n",
        "        })\n",
        "\n",
        "        # Separate by answer type\n",
        "        if row['answer_type'] == 'CLOSED':\n",
        "            results['closed']['predictions'].append(pred_clean)\n",
        "            results['closed']['ground_truths'].append(gt_clean)\n",
        "        else:  # OPEN\n",
        "            results['open']['predictions'].append(pred_clean)\n",
        "            results['open']['ground_truths'].append(gt_clean)\n",
        "\n",
        "    # Convert to DataFrame for analysis\n",
        "    df_results = pd.DataFrame(results['all'])\n",
        "\n",
        "    # ===== OVERALL ACCURACY =====\n",
        "    overall_correct = (df_results['prediction'] == df_results['ground_truth']).sum()\n",
        "    overall_acc = overall_correct / len(df_results) * 100\n",
        "\n",
        "    # ===== CLOSED-ENDED ACCURACY (WITH REGEX CLEANING) =====\n",
        "    closed_correct = 0\n",
        "    for pred, gt in zip(results['closed']['predictions'], results['closed']['ground_truths']):\n",
        "        pred_cleaned = clean_closed_answer(pred)\n",
        "        gt_cleaned = clean_closed_answer(gt)\n",
        "\n",
        "        if pred_cleaned == gt_cleaned:\n",
        "            closed_correct += 1\n",
        "\n",
        "    closed_acc = (closed_correct / len(results['closed']['predictions']) * 100) if results['closed']['predictions'] else 0\n",
        "\n",
        "    # ===== OPEN-ENDED METRICS =====\n",
        "    open_exact = []\n",
        "    open_bleu4 = []\n",
        "    open_rouge_l = []\n",
        "\n",
        "    rouge_scorer_obj = rouge_scorer.RougeScorer(['rougeL'], use_stemmer=True)\n",
        "    smoothing = SmoothingFunction()\n",
        "\n",
        "    for pred, gt in zip(results['open']['predictions'], results['open']['ground_truths']):\n",
        "        # Exact Match (using full predictions)\n",
        "        exact = 1.0 if pred == gt else 0.0\n",
        "        open_exact.append(exact)\n",
        "\n",
        "        # Tokenize\n",
        "        pred_tokens = pred.split()\n",
        "        gt_tokens = gt.split()\n",
        "\n",
        "        # BLEU-4\n",
        "        if len(pred_tokens) > 0 and len(gt_tokens) > 0:\n",
        "            bleu4 = sentence_bleu(\n",
        "                [gt_tokens],\n",
        "                pred_tokens,\n",
        "                weights=(0.25, 0.25, 0.25, 0.25),\n",
        "                smoothing_function=smoothing.method1\n",
        "            )\n",
        "        else:\n",
        "            bleu4 = 0.0\n",
        "        open_bleu4.append(bleu4)\n",
        "\n",
        "        # ROUGE-L\n",
        "        rouge_scores = rouge_scorer_obj.score(gt, pred)\n",
        "        open_rouge_l.append(rouge_scores['rougeL'].fmeasure)\n",
        "\n",
        "    # Calculate averages\n",
        "    open_exact_avg = np.mean(open_exact) * 100 if open_exact else 0\n",
        "    open_bleu4_avg = np.mean(open_bleu4) * 100 if open_bleu4 else 0\n",
        "    open_rouge_l_avg = np.mean(open_rouge_l) * 100 if open_rouge_l else 0\n",
        "\n",
        "    # ===== PRINT RESULTS =====\n",
        "    print(\"\\n\" + \"=\"*70)\n",
        "    print(\" \" * 20 + \"EVALUATION RESULTS (WITH REGEX CLEANING)\")\n",
        "    print(\"=\"*70)\n",
        "\n",
        "    print(f\"\\n📊 OVERALL PERFORMANCE:\")\n",
        "    print(f\"   Accuracy: {overall_acc:.2f}% ({overall_correct}/{len(df_results)})\")\n",
        "\n",
        "    print(f\"\\n📊 BY ANSWER TYPE:\")\n",
        "    print(f\"   Closed-ended ({len(results['closed']['predictions'])} samples):\")\n",
        "    print(f\"      Accuracy: {closed_acc:.2f}% ({closed_correct}/{len(results['closed']['predictions'])})\")\n",
        "    print(f\"      ✨ Now using regex to extract yes/no from verbose answers!\")\n",
        "\n",
        "    print(f\"\\n   Open-ended ({len(results['open']['predictions'])} samples):\")\n",
        "    print(f\"      Exact Match:  {open_exact_avg:.2f}%\")\n",
        "    print(f\"      BLEU-4:       {open_bleu4_avg:.2f}%\")\n",
        "    print(f\"      ROUGE-L:      {open_rouge_l_avg:.2f}%\")\n",
        "\n",
        "    print(f\"\\n📊 BY QUESTION TYPE:\")\n",
        "    for qtype in df_results['question_type'].value_counts().index[:10]:\n",
        "        mask = df_results['question_type'] == qtype\n",
        "        correct = (df_results[mask]['prediction'] == df_results[mask]['ground_truth']).sum()\n",
        "        total = mask.sum()\n",
        "        acc = correct / total * 100\n",
        "        print(f\"   {qtype:15s}: {acc:5.2f}% ({correct}/{total})\")\n",
        "\n",
        "    print(\"\\n\" + \"=\"*70)\n",
        "\n",
        "    return {\n",
        "        'overall_acc': overall_acc,\n",
        "        'closed_acc': closed_acc,\n",
        "        'open_exact': open_exact_avg,\n",
        "        'open_bleu4': open_bleu4_avg,\n",
        "        'open_rouge_l': open_rouge_l_avg,\n",
        "        'df_results': df_results,\n",
        "        'results': results\n",
        "    }\n",
        "\n",
        "\n"
      ],
      "metadata": {
        "id": "qh18KrG_U2_q"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Run complete evaluation with improved regex cleaning\n",
        "metrics = evaluate_comprehensive(vlm_model, test_df, tokenizer, device)"
      ],
      "metadata": {
        "id": "RHTtThGITgc1"
      },
      "execution_count": null,
      "outputs": []
    }
  ]
}
